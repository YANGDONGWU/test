name: Deploy New Test Server

on:
  push:
    branches:
      - main

env:
  BIN_NAME: new_test_server
  BASE_PATH: /usr/local/games/NewTestServer

jobs:
  deploy:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        server: [ "18.139.123.249" ] # 多台服务器列表 预发-18.139.123.249 测试-待提供
    steps:
      # 1️⃣ 拉代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Go 环境（只用于 CI 构建）
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.1'

      # 3️⃣ 构建
      - name: Build Go project
        working-directory: .
        run: |
          go mod tidy
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
          go build -o ${{ env.BIN_NAME }} main.go

      # 4️⃣ 上传新二进制（临时文件，不影响线上）
      - name: Upload new binary
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ matrix.server }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          source: ${{ env.BIN_NAME }}
          target: ${{ env.BASE_PATH }}/tmp
          overwrite: true                       # 每次覆盖
          strip_components: 1                   # 裁掉路径

      # 5️⃣ 原子切换 + 重启（无空档）
      - name: Switch binary and restart
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ matrix.server }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            set -e
            
            APP_DIR=${{ env.BASE_PATH }}
            BIN=${{ env.BIN_NAME }}
            
            mv $APP_DIR/tmp/$BIN $APP_DIR/$BIN.new
            
            echo "== stop old process (if exists) =="
            pgrep -f "$APP_DIR/$BIN" && pkill -f "$APP_DIR/$BIN" || echo "no old process"
            
            echo "== atomic replace binary =="
            mv $APP_DIR/$BIN.new $APP_DIR/$BIN
            chmod +x $APP_DIR/$BIN
            
            echo "== start new process =="
            # 确保日志目录存在
            mkdir -p ${{ env.BASE_PATH }}/log
            
            nohup $APP_DIR/$BIN \
              > ${{ env.BASE_PATH }}/log/log.txt 2>&1 &
            
            echo "== deploy success =="
